{% extends "base.html" %}

{% block title %}Email Settings - PlacementPro{% endblock %}

{% block content %}
<style>
    .settings-banner {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border-radius: 20px;
        padding: 3rem 2.5rem;
        margin-bottom: 2.5rem;
        color: white;
        box-shadow: var(--shadow-xl);
        position: relative;
        overflow: hidden;
    }

    .settings-banner::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }

    .settings-banner-content {
        position: relative;
        z-index: 1;
    }

    .settings-banner h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
    }

    .settings-banner p {
        font-size: 1.1rem;
        opacity: 0.95;
    }

    .settings-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }

    .settings-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border);
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-active {
        background: #ECFDF5;
        color: #065F46;
    }

    .status-inactive {
        background: #FEF2F2;
        color: #991B1B;
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section-title {
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--dark);
        font-weight: 600;
        font-size: 0.95rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.9rem 1.1rem;
        border: 2px solid var(--border);
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s;
        background: var(--light-gray);
        font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(15, 76, 129, 0.1);
    }

    .form-group small {
        color: var(--gray);
        font-size: 0.85rem;
        margin-top: 0.4rem;
        display: block;
    }

    .input-group {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.75rem;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--success);
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    .toggle-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--light-gray);
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    .toggle-info h4 {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.3rem;
    }

    .toggle-info p {
        color: var(--gray);
        font-size: 0.85rem;
    }

    .btn-test {
        padding: 0.8rem 1.5rem;
        background: white;
        color: var(--primary);
        border: 2px solid var(--primary);
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-test:hover {
        background: var(--primary);
        color: white;
    }

    .btn-save {
        width: 100%;
        padding: 1.1rem;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.05rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-fetch {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, var(--accent), var(--accent-hover));
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 1rem;
    }

    .btn-fetch:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-delete {
        width: 100%;
        padding: 1rem;
        background: var(--error);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-delete:hover {
        background: #DC2626;
        transform: translateY(-2px);
    }

    .info-card {
        background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-left: 4px solid var(--primary);
    }

    .info-card h4 {
        color: var(--dark);
        font-weight: 700;
        margin-bottom: 0.75rem;
    }

    .info-card ul {
        list-style: none;
        padding: 0;
    }

    .info-card li {
        color: var(--gray);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        padding-left: 1.5rem;
        position: relative;
    }

    .info-card li::before {
        content: '‚úì';
        position: absolute;
        left: 0;
        color: var(--success);
        font-weight: bold;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-box {
        background: var(--light-gray);
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary);
    }

    .stat-label {
        color: var(--gray);
        font-size: 0.85rem;
        margin-top: 0.3rem;
    }

    .log-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .log-item {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .log-item:last-child {
        border-bottom: none;
    }

    .log-info {
        flex: 1;
    }

    .log-time {
        font-size: 0.85rem;
        color: var(--gray);
        margin-bottom: 0.3rem;
    }

    .log-details {
        color: var(--dark);
        font-weight: 600;
    }

    .log-status {
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .log-success {
        background: #ECFDF5;
        color: #065F46;
    }

    .log-error {
        background: #FEF2F2;
        color: #991B1B;
    }

    @media (max-width: 1024px) {
        .settings-container {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="settings-banner">
    <div class="settings-banner-content">
        <h1>üìß Email Configuration</h1>
        <p>Connect your Gmail account to automatically fetch placement opportunities</p>
    </div>
</div>

<div class="settings-container">
    <!-- Main Configuration -->
    <div class="settings-card">
        <div class="card-header">
            <h3 class="card-title">
                <span>‚öôÔ∏è</span> Configuration Settings
            </h3>
            {% if config and config['is_enabled'] %}
            <span class="status-badge status-active">‚óè Active</span>
            {% else %}
            <span class="status-badge status-inactive">‚óè Inactive</span>
            {% endif %}
        </div>

        <!-- How to Get App Password Info -->
        <div class="info-card">
            <h4>üìå How to Get Gmail App Password</h4>
            <ul>
                <li>Go to your Google Account settings</li>
                <li>Navigate to Security ‚Üí 2-Step Verification</li>
                <li>Scroll down to "App passwords"</li>
                <li>Select "Mail" and your device</li>
                <li>Copy the 16-character password</li>
            </ul>
        </div>

        <form method="POST" action="{{ url_for('save_email_config') }}" id="configForm">
            <!-- Email Credentials -->
            <div class="form-section">
                <div class="form-section-title">
                    <span>üîê</span> Email Credentials
                </div>

                <div class="form-group">
                    <label for="email_address">Gmail Address *</label>
                    <input type="email" 
                           id="email_address" 
                           name="email_address" 
                           value="{{ config['email_address'] if config else '' }}"
                           placeholder="your.email@gmail.com"
                           required>
                    <small>Use your Gmail address for placement emails</small>
                </div>

                <div class="form-group">
                    <label for="app_password">App Password *</label>
                    <div class="input-group">
                        <input type="password" 
                               id="app_password" 
                               name="app_password" 
                               value="{{ config['app_password'] if config else '' }}"
                               placeholder="Enter 16-character app password"
                               required>
                        <button type="button" class="btn-test" onclick="testConnection()">
                            Test Connection
                        </button>
                    </div>
                    <small>Generate this from Google Account ‚Üí Security ‚Üí App Passwords</small>
                </div>
            </div>

            <!-- Enable/Disable Toggles -->
            <div class="form-section">
                <div class="form-section-title">
                    <span>üéõÔ∏è</span> Enable/Disable Features
                </div>

                <div class="toggle-group">
                    <div class="toggle-info">
                        <h4>Enable Email Integration</h4>
                        <p>Turn on to start fetching placement emails</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" 
                               name="is_enabled" 
                               {{ 'checked' if config and config['is_enabled'] else '' }}>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="toggle-group">
                    <div class="toggle-info">
                        <h4>Auto-Fetch Enabled</h4>
                        <p>Automatically fetch emails at regular intervals</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" 
                               name="auto_fetch_enabled" 
                               {{ 'checked' if config and config['auto_fetch_enabled'] else '' }}>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- Fetch Settings -->
            <div class="form-section">
                <div class="form-section-title">
                    <span>‚è±Ô∏è</span> Fetch Settings
                </div>

                <div class="form-group">
                    <label for="fetch_interval_minutes">Auto-Fetch Interval (minutes)</label>
                    <select id="fetch_interval_minutes" name="fetch_interval_minutes">
                        <option value="15" {{ 'selected' if config and config['fetch_interval_minutes'] == 15 else '' }}>Every 15 minutes</option>
                        <option value="30" {{ 'selected' if config and config['fetch_interval_minutes'] == 30 else '' }}>Every 30 minutes</option>
                        <option value="60" {{ 'selected' if config and config['fetch_interval_minutes'] == 60 else '' }}>Every 1 hour</option>
                        <option value="120" {{ 'selected' if config and config['fetch_interval_minutes'] == 120 else '' }}>Every 2 hours</option>
                        <option value="360" {{ 'selected' if config and config['fetch_interval_minutes'] == 360 else '' }}>Every 6 hours</option>
                        <option value="720" {{ 'selected' if config and config['fetch_interval_minutes'] == 720 else '' }}>Every 12 hours</option>
                    </select>
                    <small>How often to automatically check for new emails</small>
                </div>

                <div class="form-group">
                    <label for="emails_to_fetch">Number of Recent Emails to Fetch</label>
                    <select id="emails_to_fetch" name="emails_to_fetch">
                        <option value="50" {{ 'selected' if config and config['emails_to_fetch'] == 50 else '' }}>Last 50 emails</option>
                        <option value="100" {{ 'selected' if config and config['emails_to_fetch'] == 100 else '' }}>Last 100 emails</option>
                        <option value="200" {{ 'selected' if config and config['emails_to_fetch'] == 200 else '' }}>Last 200 emails</option>
                        <option value="500" {{ 'selected' if config and config['emails_to_fetch'] == 500 else '' }}>Last 500 emails</option>
                    </select>
                    <small>Maximum emails to check in each fetch</small>
                </div>

                <div class="form-group">
                    <label for="filter_keywords">Filter Keywords (comma-separated)</label>
                    <textarea id="filter_keywords" 
                              name="filter_keywords" 
                              rows="3">{{ config['filter_keywords'] if config else 'placement,job,recruitment,opportunity,hiring,career' }}</textarea>
                    <small>Only emails containing these keywords will be processed</small>
                </div>
            </div>

            <!-- Action Buttons -->
            <button type="submit" class="btn-save">
                üíæ Save Configuration
            </button>
        </form>

        {% if config %}
        <form method="POST" action="{{ url_for('delete_email_config') }}" style="margin-top: 1rem;" onsubmit="return confirm('Are you sure you want to delete this configuration?');">
            <button type="submit" class="btn-delete">
                üóëÔ∏è Delete Configuration
            </button>
        </form>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div>
       <div class="settings-card">
    <div class="card-header">
        <h3 class="card-title">
            <span>‚ö°</span> Quick Actions
        </h3>
    </div>

    {% if config and config['is_enabled'] %}
    
    <!-- Bulk Processing Section -->
    <div class="action-section">
        <h4 class="action-title">üì¶ Bulk Email Processing</h4>
        <div class="form-group">
            <label for="bulk_batch_size">Number of emails to fetch</label>
            <input type="number" 
                   id="bulk_batch_size" 
                   value="50" 
                   min="10" 
                   max="500" 
                   class="batch-input">
            <small>Fetch and analyze emails in one batch (10-500)</small>
        </div>
        <button onclick="startBulkProcessing()" class="btn-fetch" id="bulkBtn">
            üì• Start Bulk Processing
        </button>
        <div id="bulkStatus" class="status-message" style="display: none;"></div>
    </div>

    <div style="height: 1px; background: var(--border); margin: 1.5rem 0;"></div>

    <!-- Live Monitoring Section -->
    <div class="action-section">
        <h4 class="action-title">üî¥ Live Email Monitoring</h4>
        <p class="action-desc">Monitor emails in real-time. Runs in background even when you navigate away.</p>
        
        <button onclick="toggleMonitoring()" class="btn-monitor" id="monitorBtn">
            ‚ñ∂Ô∏è Start Live Monitoring
        </button>
        
        <div id="monitoringStatus" class="monitoring-panel" style="display: none;">
            <div class="status-badge-live">
                <span class="pulse-dot"></span>
                <span>LIVE</span>
            </div>
            <div class="monitor-stats">
                <div class="monitor-stat">
                    <div class="stat-label">Duration</div>
                    <div class="stat-value" id="monitorDuration">00:00:00</div>
                </div>
                <div class="monitor-stat">
                    <div class="stat-label">Checks</div>
                    <div class="stat-value" id="monitorChecks">0</div>
                </div>
                <div class="monitor-stat" style="visibility: hidden;">
                    <div class="stat-label">Emails Processed</div>
                    <div class="stat-value" id="monitorProcessed">0</div>
                </div>
                <div class="monitor-stat" style="visibility: hidden;">
                    <div class="stat-label">New Jobs</div>
                    <div class="stat-value" id="monitorJobs">0</div>
                </div>
            </div>
            <div class="monitor-log" id="monitorLog"></div>
        </div>
    </div>

    {% else %}
    <button class="btn-fetch" disabled style="opacity: 0.5; cursor: not-allowed;">
        üì• Configure Email First
    </button>
    <small style="color: var(--gray); text-align: center; display: block;">
        Enable email integration to use these features
    </small>
    {% endif %}

    <div class="stats-grid" style="margin-top: 1.5rem;" style="visibility: hidden;">
        <div class="stat-box" style="visibility: hidden;">
            <div class="stat-value">{{ logs|length }}</div>
            <div class="stat-label">Total Fetches</div>
        </div>
        <div class="stat-box" style="visibility: hidden;">
            <div class="stat-value">
                {% if config and config['last_fetch_time'] %}
                {{ config['last_fetch_time'][:10] }}
                {% else %}
                Never
                {% endif %}
            </div>
            <div class="stat-label">Last Fetch</div>
        </div>
    </div>
</div>



        <!-- Fetch Logs -->
        <div class="settings-card" style="visibility: hidden;">
            <div class="card-header">
                <h3 class="card-title">
                    <span>üìä</span> Recent Activity
                </h3>
            </div>

            <div class="log-list">
                {% if logs %}
                    {% for log in logs %}
                    <div class="log-item">
                        <div class="log-info">
                            <div class="log-time">{{ log['fetch_time'][:19] }}</div>
                            <div class="log-details">
                                {% if log['status'] == 'success' %}
                                {{ log['emails_fetched'] }} emails ‚Ä¢ {{ log['new_jobs_found'] }} jobs
                                {% else %}
                                Error: {{ log['error_message'][:50] }}
                                {% endif %}
                            </div>
                        </div>
                        <span class="log-status {{ 'log-success' if log['status'] == 'success' else 'log-error' }}">
                            {{ log['status'].upper() }}
                        </span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                        <p>No fetch history yet</p>
                        <small>Activity will appear here after first fetch</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Help Card -->
        <div class="settings-card" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-left: 4px solid var(--warning);">
            <h4 style="color: var(--dark); margin-bottom: 1rem; font-weight: 700;">
                üí° Pro Tips
            </h4>
            <ul style="list-style: none; padding: 0;">
                <li style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0.75rem; padding-left: 1.5rem; position: relative;">
                    <span style="position: absolute; left: 0;">‚Ä¢</span>
                    Use specific keywords for better filtering
                </li>
                <li style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0.75rem; padding-left: 1.5rem; position: relative;">
                    <span style="position: absolute; left: 0;">‚Ä¢</span>
                    Lower intervals mean more frequent checks
                </li>
                <li style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0.75rem; padding-left: 1.5rem; position: relative;">
                    <span style="position: absolute; left: 0;">‚Ä¢</span>
                    Test connection before enabling
                </li>
                <li style="color: var(--gray); font-size: 0.9rem; padding-left: 1.5rem; position: relative;">
                    <span style="position: absolute; left: 0;">‚Ä¢</span>
                    Keep your app password secure
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- Add these styles to your style section -->
<style>
.action-section {
    padding: 1rem 0;
}

.action-title {
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.action-desc {
    color: var(--gray);
    font-size: 0.85rem;
    margin-bottom: 1rem;
}

.batch-input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.btn-monitor {
    width: 100%;
    padding: 1rem;
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 1rem;
}

.btn-monitor:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
}

.btn-monitor.active {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
}

.monitoring-panel {
    background: #F9FAFB;
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 1rem;
}

.status-badge-live {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #FEE2E2;
    color: #991B1B;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.85rem;
    margin-bottom: 1rem;
}

.pulse-dot {
    width: 10px;
    height: 10px;
    background: #EF4444;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.monitor-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.monitor-stat {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.monitor-stat .stat-label {
    font-size: 0.75rem;
    color: var(--gray);
    margin-bottom: 0.25rem;
}

.monitor-stat .stat-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
}

.monitor-log {
    max-height: 150px;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 0.85rem;
    font-family: monospace;
}

.monitor-log-entry {
    padding: 0.25rem 0;
    color: var(--gray);
    border-bottom: 1px solid var(--border);
}

.monitor-log-entry:last-child {
    border-bottom: none;
}

.status-message {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
}

.status-message.success {
    background: #ECFDF5;
    color: #065F46;
    border-left: 4px solid #10B981;
}

.status-message.error {
    background: #FEF2F2;
    color: #991B1B;
    border-left: 4px solid #EF4444;
}

.status-message.loading {
    background: #EFF6FF;
    color: #1E40AF;
    border-left: 4px solid #3B82F6;
}
</style>


<script>
    function testConnection() {
        const email = document.getElementById('email_address').value;
        const password = document.getElementById('app_password').value;

        if (!email || !password) {
            alert('Please enter both email and app password');
            return;
        }

        const button = event.target;
        button.disabled = true;
        button.textContent = 'Testing...';

        const formData = new FormData();
        formData.append('email_address', email);
        formData.append('app_password', password);

        fetch('{{ url_for("test_email_connection") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úì ' + data.message);
                button.style.background = 'var(--success)';
                button.style.color = 'white';
                button.style.borderColor = 'var(--success)';
            } else {
                alert('‚úó ' + data.error);
                button.style.background = 'var(--error)';
                button.style.color = 'white';
                button.style.borderColor = 'var(--error)';
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = 'Test Connection';
            setTimeout(() => {
                button.style.background = '';
                button.style.color = '';
                button.style.borderColor = '';
            }, 3000);
        });
    }
</script>

<script>
let monitoringActive = false;
let eventSource = null;
let startTime = null;
let durationInterval = null;

// Bulk Processing Function
async function startBulkProcessing() {
    const batchSize = parseInt(document.getElementById('bulk_batch_size').value);
    const bulkBtn = document.getElementById('bulkBtn');
    const statusDiv = document.getElementById('bulkStatus');
    
    if (batchSize < 10 || batchSize > 500) {
        alert('Please enter a batch size between 10 and 500');
        return;
    }
    
    // Disable button and show loading
    bulkBtn.disabled = true;
    bulkBtn.innerHTML = '‚è≥ Processing...';
    statusDiv.style.display = 'block';
    statusDiv.className = 'status-message loading';
    statusDiv.innerHTML = `üîÑ Fetching and analyzing ${batchSize} emails...`;
    
    try {
        const response = await fetch('{{ url_for("bulk_fetch_emails") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ batch_size: batchSize })
        });
        
        const data = await response.json();
        
        if (data.success) {
            statusDiv.className = 'status-message success';
            statusDiv.innerHTML = `
                ‚úÖ <strong>Bulk Processing Complete!</strong><br>
                üìß Processed: ${data.emails_processed} emails<br>
                üíº New Jobs: ${data.new_jobs}<br>
                ‚è≠Ô∏è Skipped: ${data.skipped}
            `;
            
            // Reload page after 3 seconds to show new jobs
            setTimeout(() => location.reload(), 3000);
        } else {
            statusDiv.className = 'status-message error';
            statusDiv.innerHTML = `‚ùå Error: ${data.error}`;
        }
    } catch (error) {
        statusDiv.className = 'status-message error';
        statusDiv.innerHTML = `‚ùå Network error: ${error.message}`;
    } finally {
        bulkBtn.disabled = false;
        bulkBtn.innerHTML = 'üì• Start Bulk Processing';
    }
}

// Live Monitoring Functions
async function toggleMonitoring() {
    if (monitoringActive) {
        await stopMonitoring();
    } else {
        await startMonitoring();
    }
}

async function startMonitoring() {
    const monitorBtn = document.getElementById('monitorBtn');
    const statusPanel = document.getElementById('monitoringStatus');
    
    try {
        const response = await fetch('{{ url_for("start_live_monitoring") }}', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            monitoringActive = true;
            monitorBtn.innerHTML = '‚è∏Ô∏è Stop Monitoring';
            monitorBtn.classList.add('active');
            statusPanel.style.display = 'block';
            
            startTime = Date.now();
            startDurationTimer();
            connectEventSource();
            
            addLogEntry('‚úÖ Live monitoring started');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Failed to start monitoring: ' + error.message);
    }
}

async function stopMonitoring() {
    const monitorBtn = document.getElementById('monitorBtn');
    
    try {
        const response = await fetch('{{ url_for("stop_live_monitoring") }}', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            monitoringActive = false;
            monitorBtn.innerHTML = '‚ñ∂Ô∏è Start Live Monitoring';
            monitorBtn.classList.remove('active');
            
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
            
            addLogEntry('‚èπÔ∏è Monitoring stopped');
            
            if (data.stats && data.stats.new_jobs > 0) {
                setTimeout(() => location.reload(), 2000);
            }
        }
    } catch (error) {
        console.error('Error stopping monitoring:', error);
    }
}

function connectEventSource() {
    eventSource = new EventSource('{{ url_for("monitoring_stream") }}');
    
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        if (data.active) {
            document.getElementById('monitorChecks').textContent = data.stats.checks || 0;
            document.getElementById('monitorProcessed').textContent = data.stats.processed || 0;
            document.getElementById('monitorJobs').textContent = data.stats.new_jobs || 0;
            
            if (data.stats.processed > 0) {
                addLogEntry(`[${data.timestamp}] ‚úâÔ∏è Processed email, Jobs found: ${data.stats.new_jobs}`);
            }
        } else {
            if (monitoringActive) {
                stopMonitoring();
            }
        }
    };
    
    eventSource.onerror = function() {
        console.error('EventSource error');
        if (monitoringActive) {
            // Try to reconnect after 5 seconds
            setTimeout(() => {
                if (monitoringActive) {
                    connectEventSource();
                }
            }, 5000);
        }
    };
}

function startDurationTimer() {
    durationInterval = setInterval(() => {
        if (startTime) {
            const duration = Date.now() - startTime;
            const seconds = Math.floor(duration / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            const formattedTime = 
                String(hours).padStart(2, '0') + ':' +
                String(minutes % 60).padStart(2, '0') + ':' +
                String(seconds % 60).padStart(2, '0');
            
            document.getElementById('monitorDuration').textContent = formattedTime;
        }
    }, 1000);
}

function addLogEntry(message) {
    const logDiv = document.getElementById('monitorLog');
    const entry = document.createElement('div');
    entry.className = 'monitor-log-entry';
    entry.textContent = message;
    logDiv.insertBefore(entry, logDiv.firstChild);
    
    // Keep only last 10 entries
    while (logDiv.children.length > 10) {
        logDiv.removeChild(logDiv.lastChild);
    }
}

// Check monitoring status on page load
async function checkMonitoringStatus() {
    try {
        const response = await fetch('{{ url_for("monitoring_status") }}');
        const data = await response.json();
        
        if (data.success && data.active) {
            monitoringActive = true;
            const monitorBtn = document.getElementById('monitorBtn');
            const statusPanel = document.getElementById('monitoringStatus');
            
            monitorBtn.innerHTML = '‚è∏Ô∏è Stop Monitoring';
            monitorBtn.classList.add('active');
            statusPanel.style.display = 'block';
            
            // Set stats
            document.getElementById('monitorChecks').textContent = data.stats.checks || 0;
            document.getElementById('monitorProcessed').textContent = data.stats.processed || 0;
            document.getElementById('monitorJobs').textContent = data.stats.new_jobs || 0;
            document.getElementById('monitorDuration').textContent = data.duration;
            
            connectEventSource();
            addLogEntry('‚úÖ Monitoring session restored');
        }
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', checkMonitoringStatus);

// Handle page visibility changes (when user switches tabs)
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && monitoringActive) {
        // Page became visible again, check status
        checkMonitoringStatus();
    }
});
</script>

{% endblock %}